<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’¡ äº’å‹•æº«ç¿’èˆ‡æ‰‹å¯«é»˜æ›¸</title>
    <style>
        :root {
            --primary: #4a90e2;
            --secondary: #f39c12;
            --bg: #f8f9fa;
            --text: #333;
            --card-bg: #fff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            touch-action: manipulation;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            font-size: 26px;
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
            font-weight: 800;
        }

        /* å°èˆªæ¬„ / æ¨¡å¼åˆ‡æ› */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #e9ecef;
            padding: 5px;
            border-radius: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .nav-tabs button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            color: #6c757d;
            transition: all 0.3s;
        }
        .nav-tabs button.active {
            background: #fff;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: none; 
        }
        .container.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .progress {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            background: #e3f2fd;
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* --- å­—è©å¡æ¨¡å¼æ¨£å¼ --- */
        .flashcard-scene {
            width: 100%;
            height: 280px; /* åŠ é«˜ä»¥å®¹ç´å¤§å­—é«” */
            perspective: 1000px;
            margin-bottom: 20px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            transform-style: preserve-3d;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid #e9ecef;
        }
        .card-front {
            background-color: #fff;
        }
        #fc-question {
            font-size: 26px; /* æ”¾å¤§é¡Œç›®å­—é«” */
            font-weight: bold;
            color: #2c3e50;
        }
        .card-front .hint {
            font-size: 28px;
            margin-top: 15px;
            color: #7f8c8d;
        }
        .card-back {
            background-color: var(--primary);
            color: white;
            transform: rotateY(180deg);
            font-size: 42px; /* æ”¾å¤§ç­”æ¡ˆå­—é«” */
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* å­—è©å¡è¼¸å…¥å€ */
        .input-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        .input-area input {
            width: 80%;
            padding: 12px;
            font-size: 20px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            text-align: center;
            outline: none;
        }
        .input-area input:focus {
            border-color: var(--primary);
        }
        .feedback {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            min-height: 27px;
        }

        /* --- æ‰‹å¯«é»˜æ›¸æ¨¡å¼æ¨£å¼ --- */
        .audio-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
        }
        .play-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
        }
        .play-btn:active { transform: scale(0.9); }
        .english-hint {
            font-size: 20px;
            color: #555;
            font-style: italic;
            font-weight: bold;
        }
        
        /* å‹•æ…‹å¤šæ ¼å®¹å™¨ */
        .grids-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
        }
        .canvas-container {
            position: relative;
            width: 110px;  /* æ¯å€‹æ ¼å­çš„å¤§å° */
            height: 110px;
            background-color: #fdfbf7;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        @media (max-width: 500px) {
            .canvas-container { width: 85px; height: 85px; } /* æ‰‹æ©Ÿè¢å¹•ç¸®å°æ ¼å­ */
        }
        /* ç±³å­—æ ¼èƒŒæ™¯ */
        .canvas-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image: 
                linear-gradient(to right, transparent 49%, #ffcccc 50%, transparent 51%),
                linear-gradient(to bottom, transparent 49%, #ffcccc 50%, transparent 51%),
                linear-gradient(45deg, transparent 49%, #ffe6e6 50%, transparent 51%),
                linear-gradient(-45deg, transparent 49%, #ffe6e6 50%, transparent 51%);
            border: 2px solid #ff9999;
            box-sizing: border-box;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            touch-action: none; /* é˜²æ­¢è§¸æ§è¢å¹•æ»¾å‹• */
        }
        .answer-reveal {
            font-size: 36px;
            font-weight: bold;
            color: #27ae60;
            min-height: 50px;
            margin-bottom: 15px;
            letter-spacing: 8px;
            text-align: center;
        }

        /* --- æŒ‰éˆ•ç¾¤çµ„ --- */
        .controls {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
            max-width: 180px;
            min-width: 120px;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #e9ecef; color: #333; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: var(--secondary); color: white; }

        /* --- çµç®—ç•«é¢ --- */
        .summary-box {
            text-align: center;
            width: 100%;
        }
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #f1f8e9;
            border: 8px solid #8bc34a;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            font-weight: bold;
            color: #33691e;
            margin: 0 auto 20px auto;
        }
        .student-name-input {
            width: 80%;
            padding: 10px;
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid var(--primary);
            border-radius: 8px;
        }
        .report-textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            background: #f9f9f9;
            resize: none;
        }

        /* --- æ‰‹å¯«ç´€éŒ„è¡¨æ ¼æ¨£å¼ --- */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: #fff;
        }
        .history-table th, .history-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }
        .history-table th {
            background-color: #f1f8e9;
            color: #33691e;
        }
        .history-img {
            max-height: 50px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        #summary-box {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
        }

    </style>
    <!-- å¼•å…¥ html2canvas ç”¨æ–¼æˆªåœ–ä¸‹è¼‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <h1>ğŸ’¡ äº’å‹•æº«ç¿’èˆ‡æ‰‹å¯«é»˜æ›¸</h1>

    <div class="nav-tabs" id="nav-tabs">
        <button id="tab-flashcard" class="active" onclick="switchMode('flashcard')">ğŸ“‘ æ¦‚å¿µå­—è©å¡ (ä½œç­”)</button>
        <button id="tab-dictation" onclick="switchMode('dictation')">âœï¸ ç²µèªè½å¯«æ¿ (æ‰‹å¯«)</button>
    </div>

    <!-- æ¨¡å¼ä¸€ï¼šå­—è©å¡ -->
    <div id="flashcard-container" class="container active">
        <div class="progress" id="fc-progress">ç¬¬ 1 / 10 é¡Œ</div>
        
        <div class="flashcard-scene" id="fc-scene">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front">
                    <div id="fc-question">é¡Œç›®è¼‰å…¥ä¸­...</div>
                    <div id="fc-hint" class="hint"></div>
                </div>
                <div class="card-face card-back" id="fc-answer">ç­”æ¡ˆ</div>
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="fc-input" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ..." autocomplete="off">
            <div id="fc-feedback" class="feedback"></div>
        </div>

        <div class="controls">
            <button class="btn btn-success" id="btn-fc-check" onclick="checkFlashcard()">âœ… æäº¤ç­”æ¡ˆ</button>
            <button class="btn btn-primary" id="btn-fc-next" style="display:none;" onclick="nextCard()">ä¸‹ä¸€é¡Œ â¡ï¸</button>
        </div>
    </div>

    <!-- æ¨¡å¼äºŒï¼šæ‰‹å¯«é»˜æ›¸ -->
    <div id="dictation-container" class="container">
        <div class="progress" id="dic-progress">ç¬¬ 1 / 16 é¡Œ</div>
        
        <div class="audio-controls">
            <button class="play-btn" onclick="playAudio()">ğŸ”Š</button>
            <div class="english-hint" id="dic-hint">Landmarks (n.)</div>
        </div>

        <!-- å‹•æ…‹ç”Ÿæˆçš„æ ¼å­å€ -->
        <div class="grids-wrapper" id="grids-wrapper"></div>

        <div class="answer-reveal" id="dic-answer"></div>

        <div class="controls" id="dic-controls-draw">
            <button class="btn btn-secondary" onclick="clearAllCanvases()">ğŸ—‘ï¸ é‡å¯«</button>
            <button class="btn btn-warning" onclick="showAnswer()">ğŸ‘ï¸ æˆ‘å¯«å¥½äº†ï¼Œçœ‹ç­”æ¡ˆï¼</button>
        </div>
        
        <!-- å­¸ç”Ÿè‡ªæˆ‘è©•ä¼°æŒ‰éˆ• (æ ¸å°ç­”æ¡ˆå¾Œå‡ºç¾) -->
        <div class="controls" id="dic-controls-eval" style="display: none;">
            <button class="btn btn-danger" onclick="markDictation(false)">âŒ å¯«éŒ¯äº†</button>
            <button class="btn btn-success" onclick="markDictation(true)">âœ… å…¨å°ï¼</button>
        </div>
    </div>

    <!-- çµç®—æˆç¸¾å–®å®¹å™¨ -->
    <div id="summary-container" class="container">
        <div class="summary-box" id="summary-box">
            <h2 id="summary-title" style="color:var(--primary); margin-bottom:15px;">ğŸ‰ å®Œæˆæ¸¬é©—ï¼</h2>
            <div class="score-circle" id="summary-score">0%</div>
            <p style="margin-bottom: 15px; font-size: 18px;" id="summary-text"></p>
            
            <input type="text" id="student-name" class="student-name-input" placeholder="ğŸ‘‰ è«‹è¼¸å…¥ä½ çš„å§“å / å­¸è™Ÿ">
            
            <textarea id="report-text" class="report-textarea" readonly></textarea>
            
            <!-- è€å¸«æ ¸å°å°ˆç”¨çš„æ‰‹å¯«ç´€éŒ„å€ -->
            <div id="visual-report-container" style="display:none; margin-top: 20px; text-align: left;">
                <h3 style="margin-bottom: 10px; color: #d35400;">ğŸ•µï¸ æ‰‹å¯«è­‰æ“š (è€å¸«æ ¸å°å€)</h3>
                <table class="history-table" id="history-table">
                    <thead>
                        <tr>
                            <th>ç­”æ¡ˆ</th>
                            <th>ä½ çš„æ‰‹å¯«</th>
                            <th>è‡ªè©•</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody">
                    </tbody>
                </table>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" id="btn-copy-report" onclick="copyReport()">ğŸ“‹ è¤‡è£½æˆç¸¾å–®çµ¦è€å¸«</button>
                <button class="btn btn-warning" id="btn-download-img" style="display:none;" onclick="downloadImageReport()">ğŸ–¼ï¸ ä¸‹è¼‰æˆç¸¾å–®åœ–ç‰‡äº¤åŠŸèª²</button>
                <button class="btn btn-secondary" onclick="resetCurrentMode()">ğŸ”„ å†æŒ‘æˆ°ä¸€æ¬¡</button>
                <button class="btn" id="btn-switch-mode" style="background: #9b59b6; color: white;" onclick="switchOppositeMode()">â¡ï¸ å˜—è©¦å¦ä¸€æ¨¡å¼</button>
            </div>
        </div>
    </div>

<script>
    // --- è³‡æ–™åº« ---
    const flashcardData = [
        { q: "æ–‡ç« çµæ§‹ï¼šå…ˆèªªå¤§çµè«–ï¼Œå†åˆ—å‡ºç´°ç¯€ã€‚", hint: "ğŸ”¼ æ­£ä¸‰è§’å½¢", a: "ç¸½åˆ†" },
        { q: "æ–‡ç« çµæ§‹ï¼šå…ˆåˆ—å‡ºç´°ç¯€ï¼Œæœ€å¾Œæ­¸ç´å‡ºçµè«–ã€‚", hint: "ğŸ”½ å€’ä¸‰è§’å½¢", a: "åˆ†ç¸½" },
        { q: "æ–‡ç« çµæ§‹ï¼šé–‹é ­é»é¡Œ â” ä¸­é–“å±•é–‹ â” çµå°¾å‘¼æ‡‰", hint: "ğŸ”", a: "ç¸½åˆ†ç¸½" },
        { q: "èªªæ˜æ‰‹æ³•ï¼šé€šéç•Œå®šä¾†èªªæ˜", hint: "ä¾‹ï¼šæ„›æƒ…æ˜¯æŒ‡...", a: "å®šç¾©èªªæ˜" },
        { q: "èªªæ˜æ‰‹æ³•ï¼šé€šéä¾‹å­ä¾†èªªæ˜", hint: "ä¾‹ï¼šè®Šè‰²é¾...", a: "èˆ‰ä¾‹èªªæ˜" },
        { q: "èªªæ˜æ‰‹æ³•ï¼šå¼•ç”¨ä»–äººçš„è©±æˆ–è‘—ä½œä¾†èªªæ˜", hint: "ä¾‹ï¼šæ­£å¦‚æ„›å› æ–¯å¦æ‰€èªª...", a: "å¼•ç”¨èªªæ˜" },
        { q: "èªªæ˜æ‰‹æ³•ï¼šä½¿ç”¨æ•¸å­—æˆ–çµ±è¨ˆæ•¸æ“šä¾†èªªæ˜", hint: "ä¾‹ï¼š4300è¬äºº...", a: "æ•¸å­—èªªæ˜" },
        { q: "èªªæ˜æ‰‹æ³•ï¼šä½¿ç”¨æ‰“æ¯”å–»çš„æ–¹æ³•æŠŠäº‹ç‰©å…·é«”å½¢è±¡åœ°ä¾†èªªæ˜", hint: "ä¾‹ï¼šç”Ÿæ´»å°±åƒ...", a: "æ¯”å–»èªªæ˜" },
        { q: "èªªæ˜æ‰‹æ³•ï¼šæŒ‰ç‰¹æ€§ã€åŠŸç”¨ç³»çµ±åŒ–åˆ†çµ„ä¾†èªªæ˜", hint: "ä¾‹ï¼šé›²å±¤åˆ†ä¸‰é¡...", a: "åˆ†é¡èªªæ˜" },
        { q: "èªªæ˜æ‰‹æ³•ï¼šå°æ¯”å·®ç•°æˆ–ç›¸ä¼¼ä¹‹è™•ä¾†èªªæ˜", hint: "ä¾‹ï¼šæŸ´æ²¹å¼•æ“ vs æ±½æ²¹å¼•æ“", a: "æ¯”è¼ƒèªªæ˜" }
    ];

    const dictationData = [
        { word: "åå‹å¤è·¡", hint: "Landmarks (n.)" },
        { word: "é›„å¥‡", hint: "Grand (adj.)" },
        { word: "è‘—å", hint: "Famous (adj.)" },
        { word: "ç¥æ…‹å„ç•°", hint: "Diverse (adj.)" },
        { word: "èˆ‰ä¸–ç½•è¦‹", hint: "Rare (adj.)" },
        { word: "ä¹…ç¶“æ²™å ´", hint: "Veteran (adj.)" },
        { word: "è½Ÿå‹•", hint: "Sensational (adj.)" },
        { word: "å·ç„¶", hint: "Towering (adj.)" },
        { word: "å¤™é¡˜", hint: "Wish (n.)" },
        { word: "å …æ¯…", hint: "Resolute (adj.)" },
        { word: "å»ºç¯‰", hint: "Building (n.)" },
        { word: "æ„æ°£æ˜‚æš", hint: "Spirited (adj.)" },
        { word: "è¸‰è¹Œ", hint: "Stumbling (adj.)" },
        { word: "é¢¨é¦³é›»æ£", hint: "Fast (adj.)" },
        { word: "å¨åš´", hint: "Majestic (adj.)" },
        { word: "ç²—ç·", hint: "Rugged (adj.)" }
    ];

    // --- å…¨å±€ç‹€æ…‹ ---
    let currentMode = 'flashcard'; // 'flashcard' æˆ– 'dictation'
    let fcIndex = 0;
    let dicIndex = 0;
    
    // æˆç¸¾ç´€éŒ„
    let fcScore = 0;
    let fcMistakes = [];
    let dicScore = 0;
    let dicMistakes = [];
    let dicRecords = []; // æ–°å¢ï¼šç”¨ä¾†å„²å­˜å­¸ç”Ÿçš„æ‰‹å¯«åœ–ç‰‡å’Œä½œç­”ç‹€æ…‹
    let currentHandwritingData = null;

    // --- æ¨¡å¼åˆ‡æ› ---
    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('tab-flashcard').classList.remove('active');
        document.getElementById('tab-dictation').classList.remove('active');
        document.getElementById('flashcard-container').classList.remove('active');
        document.getElementById('dictation-container').classList.remove('active');
        document.getElementById('summary-container').classList.remove('active');
        document.getElementById('nav-tabs').style.display = 'flex';

        if (mode === 'flashcard') {
            document.getElementById('tab-flashcard').classList.add('active');
            document.getElementById('flashcard-container').classList.add('active');
            fcIndex = 0; fcScore = 0; fcMistakes = [];
            updateFlashcard();
        } else if (mode === 'dictation') {
            document.getElementById('tab-dictation').classList.add('active');
            document.getElementById('dictation-container').classList.add('active');
            dicIndex = 0; dicScore = 0; dicMistakes = []; dicRecords = []; // é‡ç½®ç´€éŒ„
            updateDictation();
        }
    }

    // ==========================================
    // æ¨¡å¼ä¸€ï¼šå­—è©å¡é‚è¼¯ (æ‰“å­—ä½œç­”)
    // ==========================================
    const cardEl = document.getElementById('flashcard');
    const fcQ = document.getElementById('fc-question');
    const fcHint = document.getElementById('fc-hint');
    const fcA = document.getElementById('fc-answer');
    const fcProg = document.getElementById('fc-progress');
    const fcInput = document.getElementById('fc-input');
    const fcFeedback = document.getElementById('fc-feedback');
    const btnFcCheck = document.getElementById('btn-fc-check');
    const btnFcNext = document.getElementById('btn-fc-next');

    function updateFlashcard() {
        if (fcIndex >= flashcardData.length) {
            showSummary('flashcard');
            return;
        }
        
        cardEl.classList.remove('is-flipped');
        fcInput.value = "";
        fcInput.disabled = false;
        fcInput.focus();
        fcFeedback.innerHTML = "";
        btnFcCheck.style.display = "block";
        btnFcNext.style.display = "none";
        
        setTimeout(() => {
            const current = flashcardData[fcIndex];
            fcQ.innerText = current.q;
            fcHint.innerText = current.hint || "";
            fcA.innerText = current.a;
            fcProg.innerText = `ç¬¬ ${fcIndex + 1} / ${flashcardData.length} é¡Œ`;
        }, 150); 
    }

    function checkFlashcard() {
        const userAnswer = fcInput.value.trim();
        const current = flashcardData[fcIndex];

        if (userAnswer === "") {
            alert("è«‹å…ˆè¼¸å…¥ç­”æ¡ˆï¼");
            return;
        }

        fcInput.disabled = true;
        btnFcCheck.style.display = "none";
        btnFcNext.style.display = "block";
        
        if (userAnswer === current.a) {
            fcScore++;
            fcFeedback.innerHTML = '<span style="color: #27ae60;">âœ… ç­”å°äº†ï¼</span>';
        } else {
            fcMistakes.push(`${current.q} (æ­£è§£ï¼š${current.a})`);
            fcFeedback.innerHTML = `<span style="color: #e74c3c;">âŒ ç­”éŒ¯äº†ã€‚æ­£ç¢ºæ˜¯ï¼šã€Œ${current.a}ã€</span>`;
        }
        
        // ç¿»ç‰Œé¡¯ç¤ºå¤§å­—ç­”æ¡ˆ
        cardEl.classList.add('is-flipped');
    }

    // æ”¯æ´ Enter é€å‡º
    fcInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter" && !fcInput.disabled) {
            event.preventDefault();
            checkFlashcard();
        }
    });

    function nextCard() {
        fcIndex++;
        updateFlashcard();
    }

    // ==========================================
    // æ¨¡å¼äºŒï¼šæ‰‹å¯«èˆ‡èªéŸ³é‚è¼¯ (å‹•æ…‹æ ¼å­)
    // ==========================================
    const gridsWrapper = document.getElementById('grids-wrapper');
    const dicHint = document.getElementById('dic-hint');
    const dicAns = document.getElementById('dic-answer');
    const dicProg = document.getElementById('dic-progress');
    const synth = window.speechSynthesis;
    
    // å„²å­˜æ¯å€‹ canvas åŠå…¶ç¹ªåœ–ç‹€æ…‹
    let activeCanvases = [];
    let activeContexts = [];
    let isDrawingEnabled = true;

    function updateDictation() {
        if (dicIndex >= dictationData.length) {
            showSummary('dictation');
            return;
        }

        const current = dictationData[dicIndex];
        dicHint.innerText = current.hint;
        dicProg.innerText = `ç¬¬ ${dicIndex + 1} / ${dictationData.length} é¡Œ`;
        dicAns.innerText = "";
        
        document.getElementById('dic-controls-draw').style.display = 'flex';
        document.getElementById('dic-controls-eval').style.display = 'none';
        isDrawingEnabled = true;
        
        generateGrids(current.word.length);
        playAudio();
    }

    function generateGrids(charCount) {
        gridsWrapper.innerHTML = ''; // æ¸…ç©ºèˆŠæ ¼å­
        activeCanvases = [];
        activeContexts = [];

        // æ ¹æ“šå­—æ•¸ç”Ÿæˆå°æ‡‰çš„ç±³å­—æ ¼
        for(let i = 0; i < charCount; i++) {
            const container = document.createElement('div');
            container.className = 'canvas-container';
            
            const bg = document.createElement('div');
            bg.className = 'canvas-bg';
            
            const cvs = document.createElement('canvas');
            // è¨­å®šå…§éƒ¨è§£æåº¦èˆ‡ CSS é¡¯ç¤ºå¤§å°ç›¸è¿‘ï¼Œç¢ºä¿ç¹ªåœ–æ¸…æ™°
            cvs.width = 110; 
            cvs.height = 110;
            
            container.appendChild(bg);
            container.appendChild(cvs);
            gridsWrapper.appendChild(container);

            const ctx = cvs.getContext('2d');
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            activeCanvases.push(cvs);
            activeContexts.push(ctx);
            
            bindCanvasEvents(cvs, ctx);
        }
    }

    function playAudio() {
        if (synth.speaking) synth.cancel();
        const currentWord = dictationData[dicIndex].word;
        const utterThis = new SpeechSynthesisUtterance(currentWord);
        utterThis.lang = 'zh-HK'; 
        utterThis.rate = 0.85; 
        synth.speak(utterThis);
    }

    // --- å¤šç•«å¸ƒç¹ªåœ–é‚è¼¯ ---
    let currentDrawingCanvas = null;
    let currentCtx = null;
    let isDrawing = false;
    let lastX = 0; let lastY = 0;

    function getPos(e, canvas) {
        const rect = canvas.getBoundingClientRect();
        let clientX = e.clientX; let clientY = e.clientY;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX; clientY = e.touches[0].clientY;
        }
        // å°‡è¦–çª—åº§æ¨™è½‰æ›ç‚º canvas å…§éƒ¨åº§æ¨™
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function startDrawing(e) {
        if (!isDrawingEnabled) return;
        e.preventDefault();
        isDrawing = true;
        currentDrawingCanvas = e.target;
        currentCtx = currentDrawingCanvas.getContext('2d');
        const pos = getPos(e, currentDrawingCanvas);
        lastX = pos.x; lastY = pos.y;
    }

    function draw(e) {
        if (!isDrawing || e.target !== currentDrawingCanvas || !isDrawingEnabled) return;
        e.preventDefault();
        const pos = getPos(e, currentDrawingCanvas);
        currentCtx.beginPath();
        currentCtx.moveTo(lastX, lastY);
        currentCtx.lineTo(pos.x, pos.y);
        currentCtx.stroke();
        lastX = pos.x; lastY = pos.y;
    }

    function stopDrawing() {
        isDrawing = false;
        currentDrawingCanvas = null;
    }

    function bindCanvasEvents(canvas, ctx) {
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        canvas.addEventListener('touchend', stopDrawing);
    }

    function clearAllCanvases() {
        if (!isDrawingEnabled) return;
        activeCanvases.forEach(canvas => {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
    }

    function showAnswer() {
        const current = dictationData[dicIndex];
        dicAns.innerText = current.word;
        isDrawingEnabled = false; // é–å®šç•«å¸ƒä¸èƒ½å†æ”¹
        
        // ã€é˜²ä½œå¼Šæ©Ÿåˆ¶ã€‘åœ¨çœ‹ç­”æ¡ˆçš„ç¬é–“ï¼Œç«‹åˆ»å°‡å­¸ç”Ÿçš„ç•«å¸ƒåˆä½µæˆä¸€å¼µåœ–ç‰‡å„²å­˜
        captureCurrentHandwriting();
        
        document.getElementById('dic-controls-draw').style.display = 'none';
        document.getElementById('dic-controls-eval').style.display = 'flex';
    }

    // å°‡å¤šå€‹ç±³å­—æ ¼åˆä½µæˆä¸€å¼µ Base64 åœ–ç‰‡
    function captureCurrentHandwriting() {
        if (activeCanvases.length === 0) return;
        const tempCanvas = document.createElement('canvas');
        const boxSize = 110;
        tempCanvas.width = activeCanvases.length * boxSize;
        tempCanvas.height = boxSize;
        const tCtx = tempCanvas.getContext('2d');
        
        // å¡«æ»¿èƒŒæ™¯è‰²
        tCtx.fillStyle = '#fdfbf7';
        tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        activeCanvases.forEach((cvs, i) => {
            // ç•«å‡ºç°¡å–®çš„æ ¼ç·šèƒŒæ™¯
            tCtx.strokeStyle = '#ffe6e6';
            tCtx.lineWidth = 2;
            tCtx.strokeRect(i * boxSize, 0, boxSize, boxSize);
            
            // ç•«ä¸Šå­¸ç”Ÿçš„ç­†è·¡
            tCtx.drawImage(cvs, i * boxSize, 0, boxSize, boxSize);
            
            // ç•«å¤–æ¡†
            tCtx.strokeStyle = '#bdc3c7';
            tCtx.lineWidth = 2;
            tCtx.strokeRect(i * boxSize, 0, boxSize, boxSize);
        });
        currentHandwritingData = tempCanvas.toDataURL('image/png');
    }

    function markDictation(isCorrect) {
        // å„²å­˜æ­¤é¡Œçš„å®Œæ•´ç´€éŒ„ï¼ˆåŒ…å«æ‰‹å¯«åœ–ç‰‡ï¼‰
        dicRecords.push({
            word: dictationData[dicIndex].word,
            image: currentHandwritingData,
            isCorrect: isCorrect
        });

        if (isCorrect) {
            dicScore++;
        } else {
            dicMistakes.push(dictationData[dicIndex].word);
        }
        dicIndex++;
        updateDictation();
    }

    // ==========================================
    // æˆç¸¾çµç®—èˆ‡åŒ¯å‡ºç³»çµ±
    // ==========================================
    function showSummary(mode) {
        document.getElementById('flashcard-container').classList.remove('active');
        document.getElementById('dictation-container').classList.remove('active');
        document.getElementById('nav-tabs').style.display = 'none'; // éš±è—å°èˆª
        document.getElementById('summary-container').classList.add('active');

        let totalQ = 0;
        let score = 0;
        let modeName = "";
        let mistakes = [];

        if (mode === 'flashcard') {
            totalQ = flashcardData.length;
            score = fcScore;
            modeName = "æ¦‚å¿µå­—è©å¡ (ä½œç­”)";
            mistakes = fcMistakes;
        } else {
            totalQ = dictationData.length;
            score = dicScore;
            modeName = "ç²µèªè½å¯«æ¿ (æ‰‹å¯«)";
            mistakes = dicMistakes;
        }

        const percentage = Math.round((score / totalQ) * 100);
        document.getElementById('summary-score').innerText = `${percentage}%`;
        document.getElementById('summary-text').innerText = `ä½ åœ¨ã€Œ${modeName}ã€æ¨¡å¼ä¸­ï¼Œç­”å°äº† ${score} / ${totalQ} é¡Œã€‚`;

        // æ ¹æ“šæ¨¡å¼åˆ‡æ› UI é¡¯ç¤º
        const visualReportContainer = document.getElementById('visual-report-container');
        const btnCopyReport = document.getElementById('btn-copy-report');
        const btnDownloadImg = document.getElementById('btn-download-img');
        const btnSwitchMode = document.getElementById('btn-switch-mode');

        if (mode === 'dictation') {
            // æ‰‹å¯«æ¨¡å¼ï¼šé¡¯ç¤ºæ‰‹å¯«ç´€éŒ„è¡¨ï¼Œä¸¦æä¾›ã€Œä¸‹è¼‰åœ–ç‰‡ã€æŒ‰éˆ•
            visualReportContainer.style.display = 'block';
            btnDownloadImg.style.display = 'block';
            btnCopyReport.style.display = 'none'; // éš±è—ç´”æ–‡å­—è¤‡è£½
            document.getElementById('report-text').style.display = 'none'; // éš±è—æ–‡å­—æ¡†
            btnSwitchMode.innerText = "â¡ï¸ å»æŒ‘æˆ°ã€æ¦‚å¿µå­—è©å¡ã€‘";

            // å»ºç«‹æ‰‹å¯«åœ–ç‰‡è¡¨æ ¼
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            dicRecords.forEach(record => {
                const tr = document.createElement('tr');
                
                const tdWord = document.createElement('td');
                tdWord.innerText = record.word;
                tdWord.style.fontWeight = 'bold';
                
                const tdImg = document.createElement('td');
                if (record.image) {
                    const img = document.createElement('img');
                    img.src = record.image;
                    img.className = 'history-img';
                    tdImg.appendChild(img);
                } else {
                    tdImg.innerText = "æœªä½œç­”";
                }
                
                const tdStatus = document.createElement('td');
                tdStatus.innerHTML = record.isCorrect ? 'âœ…<br><small style="color:gray;">(è‡ªç¨±å°)</small>' : 'âŒ<br><small style="color:gray;">(è‡ªç¨±éŒ¯)</small>';
                
                tr.appendChild(tdWord);
                tr.appendChild(tdImg);
                tr.appendChild(tdStatus);
                tbody.appendChild(tr);
            });

        } else {
            // å­—è©å¡æ¨¡å¼ï¼šåªé¡¯ç¤ºç´”æ–‡å­—å ±å‘Š
            visualReportContainer.style.display = 'none';
            btnDownloadImg.style.display = 'none';
            btnCopyReport.style.display = 'block';
            document.getElementById('report-text').style.display = 'block';
            btnSwitchMode.innerText = "â¡ï¸ å»æŒ‘æˆ°ã€æ‰‹å¯«é»˜æ›¸ã€‘";
        }

        // ç”Ÿæˆæ–‡å­—å ±å‘Šæ¨¡æ¿
        const dateStr = new Date().toLocaleString('zh-HK');
        let reportStr = `ğŸ“ èªæ–‡äº’å‹•é»˜æ›¸æˆç¸¾å–®\n`;
        reportStr += `æ™‚é–“ï¼š${dateStr}\n`;
        reportStr += `æ¨¡å¼ï¼š${modeName}\n`;
        reportStr += `æˆç¸¾ï¼š${score} / ${totalQ} (${percentage}%)\n`;
        
        if (mistakes.length > 0) {
            reportStr += `\nâš ï¸ éœ€è¦æº«ç¿’çš„éŒ¯é¡Œï¼š\n`;
            mistakes.forEach(m => reportStr += `- ${m}\n`);
        } else {
            reportStr += `\nğŸŒŸ å¤ªæ£’äº†ï¼å…¨éƒ¨æ­£ç¢ºï¼\n`;
        }
        
        document.getElementById('report-text').value = reportStr;
        
        // ç›£è½å§“åè¼¸å…¥ï¼Œå³æ™‚æ›´æ–°å ±å‘Š
        document.getElementById('student-name').oninput = function() {
            const name = this.value.trim() || "æœªå‘½åå­¸ç”Ÿ";
            let updatedReport = `ğŸ§‘â€ğŸ“ å­¸ç”Ÿï¼š${name}\n` + reportStr;
            document.getElementById('report-text').value = updatedReport;
        };
        // è§¸ç™¼ä¸€æ¬¡æ›´æ–°
        document.getElementById('student-name').dispatchEvent(new Event('input'));
    }

    // æ–°å¢ï¼šå°‡æ•´å€‹æˆç¸¾å–®ï¼ˆå«æ‰‹å¯«åœ–ç‰‡ï¼‰æˆªåœ–ä¸¦ä¸‹è¼‰
    function downloadImageReport() {
        const studentName = document.getElementById('student-name').value.trim();
        if(!studentName) {
            alert("è«‹å…ˆè¼¸å…¥ä½ çš„å§“åæˆ–å­¸è™Ÿï¼Œå†ä¸‹è¼‰æˆç¸¾å–®ï¼");
            document.getElementById('student-name').focus();
            return;
        }

        // éš±è—ä¸å¿…è¦çš„æŒ‰éˆ•é¿å…è¢«æˆªåœ–é€²å»
        const controls = document.querySelector('#summary-container .controls');
        controls.style.display = 'none';
        document.getElementById('student-name').style.border = 'none';

        // ä½¿ç”¨ html2canvas æˆªåœ–
        html2canvas(document.getElementById('summary-box'), {
            backgroundColor: '#ffffff',
            scale: 2 // æé«˜æˆªåœ–è§£æåº¦
        }).then(canvas => {
            // æ¢å¾© UI ç‹€æ…‹
            controls.style.display = 'flex';
            document.getElementById('student-name').style.border = '2px solid var(--primary)';

            // è§¸ç™¼ä¸‹è¼‰åœ–ç‰‡
            const link = document.createElement('a');
            link.download = `${studentName}_é»˜æ›¸æˆç¸¾å–®.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            alert("æˆªåœ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–æ‰‹å‹•æˆªåœ–ã€‚");
            controls.style.display = 'flex';
        });
    }

    function copyReport() {
        const studentName = document.getElementById('student-name').value.trim();
        if(!studentName) {
            alert("è«‹å…ˆè¼¸å…¥ä½ çš„å§“åæˆ–å­¸è™Ÿå–”ï¼");
            document.getElementById('student-name').focus();
            return;
        }

        const reportText = document.getElementById('report-text').value;
        navigator.clipboard.writeText(reportText).then(() => {
            alert("âœ… æˆç¸¾å–®å·²è¤‡è£½ï¼\nè«‹æ‰“é–‹ WhatsApp, Google Classroom æˆ– Teams è²¼ä¸Šä¸¦å‚³é€çµ¦è€å¸«ã€‚");
        }).catch(err => {
            // Fallback èˆŠç‰ˆè¤‡è£½æ–¹æ³•
            const textArea = document.getElementById('report-text');
            textArea.select();
            document.execCommand('copy');
            alert("âœ… æˆç¸¾å–®å·²è¤‡è£½ï¼è«‹è²¼ä¸Šå‚³é€çµ¦è€å¸«ã€‚");
        });
    }

    function resetCurrentMode() {
        switchMode(currentMode);
    }

    function switchOppositeMode() {
        if (currentMode === 'flashcard') {
            switchMode('dictation');
        } else {
            switchMode('flashcard');
        }
    }

    // åˆå§‹åŒ–
    switchMode('flashcard');

</script>
</body>
</html>